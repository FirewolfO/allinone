## 盘古

- AddDeviceReq

- EventTypeEnum

  ```java
  DOOR_CONTROL__CARD_READER_DISMANTLE_ALARM(408L, 0L, "dismantleAlarm", "读卡器拆除", 400L, 4L, true),
  DOOR_CONTROL__CARD_READER_OFFLINE(409L, 0L, "dismantleAlarm", "读卡器离线", 400L, 4L, true),
  DOOR_CONTROL__DOOR_OPENED_BY_EXTERNAL_FORCE(410L, 0L, "dismantleAlarm", "门被外力开启", 400L, 4L, true),
  ```

- PassRecordExportServiceImpl



## middle-end-base

- 冲突模板文件

![image-20210909150001645](https://gitee.com/firewolf/allinone/raw/master/images/image-20210909150001645.png)

- PersonMapper.xml

sh install.sh -p /Users/liuxing/Documents/gitcode/megvii/pangu/ -q pangu-1.1.0/test -m /Users/liuxing/Documents/gitcode/megvii/middle/ -n pangu-1.1.0/test -b deploy

## middle-end-device

- ```
  DeviceConfigServiceImpl
  ```

- DeviceModeBelongEnum

## middle-end-pass

![image-20210909181320267](https://gitee.com/firewolf/allinone/raw/master/images/image-20210909181320267.png)

```java
package com.megvii.middle_end.micro.pass.provider.web;

import java.util.*;
import java.util.stream.Collectors;

import javax.annotation.Resource;

import com.megvii.bbu.common.util.lock.IRedissonLock;
import com.megvii.bbu.common.util.lock.impl.RedissionKeyFactory;
import com.megvii.bbu.middle_end.pass.domain.enums.PassRedissionKeyEnum;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.joda.time.DateTime;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.alibaba.fastjson.JSON;
import com.megvii.bbu.common.util.BeanHelper;
import com.megvii.bbu.common.util.UuidUtil;
import com.megvii.bbu.common.util.pagination.PageData;
import com.megvii.bbu.middle_end.pass.domain.bean.DeviceSetGroupScheduleRelationBean;
import com.megvii.bbu.middle_end.pass.domain.bean.DeviceSetGroupScheduleRelationDeleteBean;
import com.megvii.bbu.middle_end.pass.domain.bean.DeviceSetGroupScheduleRelationJoinBean;
import com.megvii.bbu.middle_end.pass.domain.bean.check.AuthorityCheckAddBean;
import com.megvii.bbu.middle_end.pass.domain.bean.check.AuthorityCheckUpdateBean;
import com.megvii.bbu.middle_end.pass.domain.entity.DeviceSetGroupScheduleRelationEntity;
import com.megvii.bbu.middle_end.pass.domain.entity.GroupEntity;
import com.megvii.bbu.middle_end.pass.domain.enums.ScheduleTypeEnum;
import com.megvii.bbu.middle_end.pass.service.DeviceSetGroupScheduleRelationService;
import com.megvii.bbu.middle_end.pass.service.GroupService;
import com.megvii.bbu.middle_end.pass.service.IDeviceService;
import com.megvii.bbu.middle_end.pass.service.ScheduleService;
import com.megvii.bbu.middle_end.pass.service.impl.LockService;
import com.megvii.middle_end.common.annotations.DataPermissionMultiRule;
import com.megvii.middle_end.common.annotations.bean.DataPermissionRuleBean;
import com.megvii.middle_end.common.domain.enums.BusinessExceptionEnum;
import com.megvii.middle_end.common.domain.enums.DataPermissionEnum;
import com.megvii.middle_end.common.domain.enums.DataPermissionTypeEnum;
import com.megvii.middle_end.common.domain.enums.PlatFormEnum;
import com.megvii.middle_end.common.domain.exception.BusinessException;
import com.megvii.middle_end.device.api.api.DeviceApi;
import com.megvii.middle_end.device.api.dto.request.BaseDeviceControlReq;
import com.megvii.middle_end.device.api.dto.request.DeviceConfigPublicGateReq;
import com.megvii.middle_end.device.api.dto.request.DeviceSetIdUuids;
import com.megvii.middle_end.device.api.dto.request.DeviceSetReq;
import com.megvii.middle_end.device.api.dto.response.DeviceAndSetResp;
import com.megvii.middle_end.device.api.dto.response.DeviceSimpleReps;
import com.megvii.middle_end.micro.pass.provider.service.authority.check.IAuthorityCheckService;
import com.megvii.middle_end.micro.pass.provider.service.authority.impl.AuthorityService;
import com.megvii.middle_end.pass.api.api.AuthorityApi;
import com.megvii.middle_end.pass.api.bean.AuthorityDeviceSet;
import com.megvii.middle_end.pass.api.bean.AuthorityGroup;
import com.megvii.middle_end.pass.api.dto.request.*;
import com.megvii.middle_end.pass.api.dto.response.AuthorityPageGroup;
import com.megvii.middle_end.pass.api.dto.response.AuthorityPageResp;
import com.megvii.middle_end.pass.api.dto.response.AuthorityResp;
import com.megvii.middle_end.pass.api.dto.response.DeviceSetGroupScheduleResp;

import lombok.extern.slf4j.Slf4j;

/**
 * 描述：通行权限
 *
 * @author jiaotengda@megvii.com
 * @date 2020-03-16
 */
@Slf4j
@RestController(value = "/pass/authority")
public class AuthorityController implements AuthorityApi {

    @Resource
    private DeviceSetGroupScheduleRelationService relationService;

    @Resource
    private DeviceApi deviceApi;

    @Resource
    private GroupService groupService;

    @Resource
    private IDeviceService deviceService;

    @Resource
    private ScheduleService scheduleService;

    @Value("${authority_group_max_count}")
    private Integer authorityGroupMaxCount;

    @Value("${platform.environment}")
    private String environment;
    @Resource
    private AuthorityService authorityService;
    @Resource
    private IAuthorityCheckService authorityCheckService;

    @Resource
    private LockService lockService;

    @Resource
    private IRedissonLock iRedissonLock;

    @Override
    public void add(@RequestBody AuthorityReq authorityReq) throws Exception {

        Long companyId = authorityReq.getCompanyId();
        List<Long> deviceSetIds = authorityReq.getDeviceSets().stream().map(AuthorityDeviceSet::getDeviceSetId)
            .distinct().collect(Collectors.toList());
        // 设备解绑公共门
        if (StringUtils.equals(PlatFormEnum.JIUXIAO.getName(), environment)) {
            deviceUnBindPublicDoor(deviceSetIds, companyId);
        }
        insertAuthority(authorityReq);
        // 通知mq 需要全量更新
        deviceService.noticeDeviceUpdate(deviceSetIds, true);
    }

    @Override
//    @DataPermissionMultiRule(
//        key = {@DataPermissionRuleBean(key = "#deviceSetId", type = DataPermissionTypeEnum.DEVICE),
//            @DataPermissionRuleBean(key = "#scheduleId", type = DataPermissionTypeEnum.SCHEDULE),},
//        target = "#companyId", type = DataPermissionEnum.DEVICE_SCHEDULE_CHECK)
    public  void delete(@RequestParam(value = "deviceSetId") Long deviceSetId,
        @RequestParam(value = "scheduleId") Long scheduleId, @RequestParam(value = "companyId") Long companyId) {
        // 加写锁
        String redissonKey = deviceSetId.toString() + "_" + scheduleId.toString();
        log.info("AuthorityController delete 开始申请写锁：{},{},{}", deviceSetId, scheduleId, redissonKey);
        try {
            lockService.getWriteLock(Collections.singletonList(redissonKey));

            relationService.deleteByGroupIdsOrDeviceIdsOrScheduleIds(null, Arrays.asList(deviceSetId),
                    Arrays.asList(scheduleId));
        } finally {
            log.info("AuthorityController delete 释放写锁：{},{},{}", deviceSetId, scheduleId, redissonKey);
            lockService.unWriteLock(Collections.singletonList(redissonKey));
        }
    }

    /**
     * 编辑页面：设备不可修改，人员组和时间计划可修改。 举例说明：权限（D1+P1+T1），D1不可修改，P1、T1可修改，存在2种情况 1、修改P1，T1不变。这种比较符合编辑的定义
     * 2、修改T1为T2，P1有无变化都可以。这种情况又分为2种： 1）D1+T2已存在，那么会将这两条权限合并为一条 2）D1+T2不存在，那么更新为D1+P1+T2，符合编辑定义
     * <p>
     * 发送Iot通知应该在Controller中处理 更新DeviceUpdate可以内恰在Service中
     *
     * @param updateReq
     */
    @Override
    public void update(@RequestBody AuthorityUpdateReq updateReq) throws Exception {
        RedissionKeyFactory redissionKeyFactory = PassRedissionKeyEnum.PASS_AUTH_UPDATE.getRedissionKeyFactory();
        String redisKey = PassRedissionKeyEnum.PASS_AUTH_UPDATE.buildKey();

        try {
            boolean isLocked = iRedissonLock.tryLock(redisKey, redissionKeyFactory.getWaitTime(), redissionKeyFactory.getTimeUnit());
            if(!isLocked){
                // TODO lixiang 抛出异常
            }

            log.info("更新通行权限入参：{}", JSON.toJSONString(updateReq));
            Long deviceSetId = updateReq.getDeviceSetId();
            String deviceSetUuid = updateReq.getDeviceSetUuid();

            Long companyId = updateReq.getCompanyId();
            // 设备解绑公共门
            if (StringUtils.equals(PlatFormEnum.JIUXIAO.getName(), environment)) {
                deviceUnBindPublicDoor(Collections.singletonList(deviceSetId), companyId);
            }
            AuthorityCheckUpdateBean checkUpdateBean = new AuthorityCheckUpdateBean();
            checkUpdateBean.setDeviceSetId(deviceSetId);
            authorityCheckService.checkUpdate(checkUpdateBean);
            List<Long> oldGroupIds =
                updateReq.getOldGroups().stream().map(AuthorityGroup::getGroupId).distinct().collect(Collectors.toList());
            List<Long> newGroupIds =
                updateReq.getNewGroups().stream().map(AuthorityGroup::getGroupId).distinct().collect(Collectors.toList());
            Long oldScheduleId = updateReq.getOldScheduleId();
            Long newScheduleId = updateReq.getNewScheduleId();
            if (updateReq.getNewScheduleUuid() == null) {
                updateReq.setNewScheduleUuid(scheduleService.findById(newScheduleId).getUuid());
            }
            String newScheduleUuid = updateReq.getNewScheduleUuid();

            // 旧-新，即删除的组
            ArrayList<Long> deleteGroupIds = new ArrayList<>(CollectionUtils.subtract(oldGroupIds, newGroupIds));
            // 新-旧，即增加的组
            ArrayList<Long> insertGroupIds = new ArrayList<>(CollectionUtils.subtract(newGroupIds, oldGroupIds));
            // 取交集，即不变的组
            ArrayList<Long> updateGroupIds = new ArrayList<>(CollectionUtils.intersection(newGroupIds, oldGroupIds));

            // 不管哪种情况，先对移除的组进行删除
            if (CollectionUtils.isNotEmpty(deleteGroupIds)) {
                List<DeviceSetGroupScheduleRelationDeleteBean> deleteBeans = new ArrayList<>();
                for (Long deleteGroupId : deleteGroupIds) {
                    DeviceSetGroupScheduleRelationDeleteBean deleteBean = new DeviceSetGroupScheduleRelationDeleteBean();
                    deleteBean.setDeviceSetId(deviceSetId);
                    deleteBean.setGroupId(deleteGroupId);
                    deleteBean.setScheduleId(oldScheduleId);
                    deleteBeans.add(deleteBean);
                }
                relationService.deleteByGroupIdAndDeviceIdAndScheduleId(deleteBeans);
            }

            // 不管时间计划变不变，新增组数据的逻辑的单独的
            if (CollectionUtils.isNotEmpty(insertGroupIds)) {
                AuthorityDeviceSet deviceSet = new AuthorityDeviceSet();
                deviceSet.setDeviceSetId(deviceSetId);
                deviceSet.setDeviceSetUuid(deviceSetUuid);

                List<AuthorityGroup> groups = new ArrayList<>();
                for (AuthorityGroup group : updateReq.getNewGroups()) {
                    if (insertGroupIds.contains(group.getGroupId())) {
                        groups.add(group);
                    }
                }

                AuthorityReq req = new AuthorityReq();
                req.setDeviceSets(Collections.singletonList(deviceSet));
                req.setGroups(groups);
                req.setScheduleId(newScheduleId);
                req.setScheduleUuid(newScheduleUuid);
                insertAuthority(req);
            }

            // 时间计划有变动，才需要对保留的组进行修改
            if (!oldScheduleId.equals(newScheduleId)) {
                if (CollectionUtils.isNotEmpty(updateGroupIds)) {
                    // 通过设备ID，组ID，修改时间计划
                    relationService.updateRelationByDeviceSetIdAndGroupIds(deviceSetId, updateGroupIds, newScheduleId,
                        newScheduleUuid);
                }
            }
            // 通知mq 设备全量更新
            deviceService.noticeDeviceUpdate(deviceSetId, true);
        } catch (Exception e) {
            // 如果业务异常，直接抛至上层
            if (e instanceof BusinessException) {
                throw e;
            }
            log.error("AuthorityController update:{},{}", updateReq, e);
        } finally {
            iRedissonLock.unLock(redisKey);
        }
    }

    /**
     * 设备解绑公共门
     *
     * @param deviceSetIds
     * @param companyId
     */
    private void deviceUnBindPublicDoor(List<Long> deviceSetIds, Long companyId) {
        // 查询公司拥有的全员组
        List<Long> allGroupIds = groupService.findAllGroupIdsByCompanyId(companyId).stream().map(GroupEntity::getId)
            .distinct().collect(Collectors.toList());
        if (CollectionUtils.isNotEmpty(deviceSetIds) && CollectionUtils.isNotEmpty(allGroupIds)) {
            relationService.deleteByDeviceSetIdsAndGroupIds(deviceSetIds, allGroupIds);
            // 通知设备解绑了全员组，不在是公共门
            noticeUnbindPublic(deviceSetIds, companyId);
        }
    }

    /**
     * 通知解绑定公共门
     *
     * @param deviceSetIds
     */
    private void noticeUnbindPublic(List<Long> deviceSetIds, Long companyId) {
        DeviceSetIdUuids deviceSetIdUuids = new DeviceSetIdUuids();
        deviceSetIdUuids.setDeviceSetIds(deviceSetIds);
        List<DeviceSimpleReps> deviceSimpleReps = deviceApi.queryDeviceByDeviceSetIdsOrDeviceSetUuids(deviceSetIdUuids);
        deviceSimpleReps.forEach(deviceSimpleRep -> {
            DeviceSetReq req = new DeviceSetReq();
            req.setSensorId(deviceSimpleRep.getDeviceId());
            req.setComputeId(deviceSimpleRep.getDeviceId());
            req.setIsPublic(0);
            // 需要deviceId
            deviceApi.updateDeviceSet(req);
            // 更改device_config,判断当前配置的时间戳是否是0
            DeviceConfigPublicGateReq deviceConfigPublicGateReq = new DeviceConfigPublicGateReq();
            deviceConfigPublicGateReq.setDeviceId(deviceSimpleRep.getDeviceId());
            deviceConfigPublicGateReq.setType(0);
            deviceConfigPublicGateReq.setUpdateFlag(true);
            deviceApi.updateDeviceConfigPublicGate(deviceConfigPublicGateReq);
        });

    }

    @Override
    public PageData<AuthorityPageResp> queryList(@RequestParam("companyId") Long companyId,
        @RequestParam(value = "deviceName", required = false, defaultValue = "") String deviceName,
        @RequestParam(value = "groupId", required = false, defaultValue = "") Long groupId,
        @RequestParam(value = "scheduleId", required = false, defaultValue = "") Long scheduleId,
        @RequestParam("pageNum") Integer pageNum, @RequestParam("pageSize") Integer pageSize) {

        AuthorityQueryReq authorityQueryReq = new AuthorityQueryReq();
        authorityQueryReq.setCompanyId(companyId);
        authorityQueryReq.setDeviceName(deviceName);
        authorityQueryReq.setGroupId(groupId);
        authorityQueryReq.setScheduleId(scheduleId);
        authorityQueryReq.setPageNum(pageNum);
        authorityQueryReq.setPageSize(pageSize);
        return queryList(authorityQueryReq);
    }

    @Override
//    @DataPermissionMultiRule(
//        key = {@DataPermissionRuleBean(key = "#deviceSetId", type = DataPermissionTypeEnum.DEVICE),
//            @DataPermissionRuleBean(key = "#scheduleId", type = DataPermissionTypeEnum.SCHEDULE),},
//        target = "#companyId", type = DataPermissionEnum.DEVICE_SCHEDULE_CHECK)
    public AuthorityResp query(@RequestParam("deviceSetId") Long deviceSetId,
        @RequestParam("scheduleId") Long scheduleId, @RequestParam("companyId") Long companyId) {

        if (null == deviceSetId || null == scheduleId) {
            throw new BusinessException(BusinessExceptionEnum.PARAM_ERROR);
        }

        DeviceSetGroupScheduleRelationBean bean = new DeviceSetGroupScheduleRelationBean();
        bean.setDeviceSetId(deviceSetId);
        bean.setScheduleId(scheduleId);
        List<DeviceSetGroupScheduleRelationBean> relations = relationService.getRelationsByExample(bean);

        AuthorityResp res = new AuthorityResp();
        String deviceSetUuid = "";
        String scheduleUuid = "";
        List<AuthorityGroup> groups = new ArrayList<>();
        if (!CollectionUtils.isEmpty(relations)) {
            int i = 1;
            for (DeviceSetGroupScheduleRelationBean relation : relations) {
                AuthorityGroup group = new AuthorityGroup();
                group.setGroupId(relation.getGroupId());
                group.setGroupUuid(relation.getGroupUuid());
                groups.add(group);
                if (i == 1) {
                    deviceSetUuid = relation.getDeviceSetUuid();
                    scheduleUuid = relation.getScheduleUuid();
                    i++;
                }
            }
        }
        res.setDeviceSetId(deviceSetId);
        res.setDeviceSetUuid(deviceSetUuid);
        res.setScheduleId(scheduleId);
        res.setScheduleUuid(scheduleUuid);
        res.setGroups(groups);
        return res;
    }

    /**
     * 添加通行权限逻辑，设备(n) * 组(m) * 时间计划(1)
     * <p>
     * 设备与组关系表增加记录，通知设备需要更新
     *
     * @param authorityReq
     */
    private void insertAuthority(AuthorityReq authorityReq) throws Exception {
        List<DeviceSetGroupScheduleRelationBean> beans = new ArrayList<>();
        if (authorityReq.getScheduleUuid() == null) {
            authorityReq.setScheduleUuid(scheduleService.findById(authorityReq.getScheduleId()).getUuid());
        }
        Long scheduleId = authorityReq.getScheduleId();
        String scheduleUuid = authorityReq.getScheduleUuid();
        List<AuthorityDeviceSet> deviceSets = authorityReq.getDeviceSets();
        // 加读锁
        Date date = new DateTime().toDate();
        List<AuthorityGroup> groups = authorityReq.getGroups();
        // 设备布控检查
        AuthorityCheckAddBean checkAddBean = BeanHelper.copyProperties(authorityReq, AuthorityCheckAddBean.class);
        authorityCheckService.checkAdd(checkAddBean);
        for (AuthorityDeviceSet deviceSet : deviceSets) {
            for (AuthorityGroup group : groups) {
                DeviceSetGroupScheduleRelationBean bean = new DeviceSetGroupScheduleRelationBean();
                bean.setUuid(UuidUtil.generateUuid());
                bean.setDeviceSetId(deviceSet.getDeviceSetId());
                bean.setDeviceSetUuid(deviceSet.getDeviceSetUuid());
                bean.setGroupId(group.getGroupId());
                if (group.getGroupUuid() != null) {
                    group.setGroupUuid(groupService.findById(group.getGroupId()).getUuid());
                }
                bean.setGroupUuid(group.getGroupUuid());
                bean.setScheduleId(scheduleId);
                bean.setScheduleUuid(scheduleUuid);
                bean.setGmtCreate(date);
                bean.setGmtModified(date);
                beans.add(bean);
            }
        }
        relationService.batchInsert(beans);

    }

    /**
     * 设备绑定最大组数目不超过128
     *
     * @param deviceSetIds
     */
    private void checkMaxGroupDeviceSet(List<Long> deviceSetIds, List<Long> groupIds) {
        // 查询传入deviceSetId绑定组详情
        List<DeviceSetGroupScheduleRelationEntity> relations =
            relationService.queryDeviceSets(null, deviceSetIds, null);
        List<Long> maxGroupDevices = new ArrayList<>();
        if (CollectionUtils.isNotEmpty(relations)) {
            // key-deviceSetId,value->groupIds
            Map<Long, List<Long>> relationMap =
                relations.stream().collect(Collectors.groupingBy(DeviceSetGroupScheduleRelationEntity::getDeviceSetId,
                    Collectors.mapping(DeviceSetGroupScheduleRelationEntity::getGroupId, Collectors.toList())));
            for (Map.Entry<Long, List<Long>> entry : relationMap.entrySet()) {
                Long deviceSetId = entry.getKey();
                List<Long> curGroupIds = entry.getValue();
                // 待绑定的 与 已存在的做差集 =>> 新增的
                ArrayList<Long> insertGroupIds = new ArrayList<>(CollectionUtils.subtract(groupIds, curGroupIds));
                if ((curGroupIds.size() + insertGroupIds.size()) > authorityGroupMaxCount) {
                    maxGroupDevices.add(deviceSetId);
                }
            }
        } else {
            if (groupIds.size() > authorityGroupMaxCount) {
                maxGroupDevices.addAll(deviceSetIds);
            }
        }
        if (CollectionUtils.isNotEmpty(maxGroupDevices)) {
            log.error("add，下发的通行权限满128个的设备ID：{}", maxGroupDevices);
            throw new BusinessException(BusinessExceptionEnum.DEVICESET_GROUP_FULL);
        }
    }

    @Override
    @PostMapping(value = "/api/v1/authority/delete")
    public void deleteByDeviceSetId(@RequestParam(value = "deviceSetId") Long deviceSetId) {
        relationService.deleteByGroupIdsOrDeviceIdsOrScheduleIds(null, Arrays.asList(deviceSetId), null);
    }

    @Override
    public void deleteByDeviceSetIds(@RequestBody AuthorityDeleteReq authorityDeleteReq) {
        relationService.deleteByGroupIdsOrDeviceIdsOrScheduleIds(authorityDeleteReq.getGroupIds(),
            authorityDeleteReq.getDeviceSetIds(), authorityDeleteReq.getScheduleIds());
    }

    @Override
    public PageData<AuthorityPageResp> queryList(@RequestBody AuthorityQueryReq authorityQueryReq) {
        Long companyId = authorityQueryReq.getCompanyId();
        String deviceName = authorityQueryReq.getDeviceName();
        List<Long> deviceIds = authorityQueryReq.getDeviceIds();
        Long[] deviceIdsArr =
            CollectionUtils.isNotEmpty(deviceIds) ? deviceIds.toArray(new Long[deviceIds.size()]) : null;
        Map<Long, DeviceAndSetResp> deviceSetMap =
            deviceApi.queryDeviceSetByDeviceSetIds(deviceIdsArr, companyId, deviceName).stream()
                .collect(Collectors.toMap(DeviceAndSetResp::getDeviceSetId, d -> d, (oldValue, newValue) -> newValue));

        if (!deviceSetMap.isEmpty()) {
            List<Long> deviceSetIds = new ArrayList<>(deviceSetMap.keySet());
            // 根据deviceSetId 查询 deviceId
            DeviceSetIdUuids deviceSetIdUuids = new DeviceSetIdUuids();
            deviceSetIdUuids.setDeviceSetIds(deviceSetIds);
            List<DeviceSimpleReps> deviceSimpleRepsList =
                deviceApi.queryDeviceByDeviceSetIdsOrDeviceSetUuids(deviceSetIdUuids);
            Map<Long, DeviceSimpleReps> simpleRepsMap =
                deviceSimpleRepsList.stream().collect(Collectors.toMap(DeviceSimpleReps::getDeviceSetId, v -> v));

            // 查询已绑定时间计划的组
            Long groupId = authorityQueryReq.getGroupId();
            Long scheduleId = authorityQueryReq.getScheduleId();
            int pageNum = authorityQueryReq.getPageNum();
            int pageSize = authorityQueryReq.getPageSize();
            PageData<DeviceSetGroupScheduleRelationJoinBean> pageData =
                relationService.queryRelationsByDeviceSetIdJoin(deviceSetIds, groupId, scheduleId, pageNum, pageSize);
            List<DeviceSetGroupScheduleRelationJoinBean> joinBeans = pageData.getList();

            Map<String, AuthorityPageResp> resultMap = new HashMap<>(joinBeans.size());
            for (DeviceSetGroupScheduleRelationJoinBean joinBean : joinBeans) {
                Long deviceSetId = joinBean.getDeviceSetId();
                Long deviceId = simpleRepsMap.get(deviceSetId).getDeviceId();
                String deviceUuid = simpleRepsMap.get(deviceSetId).getDeviceUuid();
                String deviceSetName = deviceSetMap.get(deviceSetId).getName();
                Long joinBeanScheduleId = joinBean.getScheduleId();
                String scheduleUuid = joinBean.getScheduleUuid();
                String scheduleName = joinBean.getScheduleName();
                Long joinBeanGroupId = joinBean.getGroupId();
                String groupUuid = joinBean.getGroupUuid();
                String groupName = joinBean.getGroupName();
                Date gmtModified = joinBean.getGmtModified();
                String key = deviceSetId + "-" + joinBeanScheduleId;

                AuthorityPageResp authorityPageResp = resultMap.get(key);
                if (null == authorityPageResp) {
                    authorityPageResp = new AuthorityPageResp();
                    // 前后端交互的都是deviceId 与 deviceUuid 这里转换一下
                    authorityPageResp.setDeviceSetId(deviceId);
                    authorityPageResp.setDeviceSetUuid(deviceUuid);
                    authorityPageResp.setDeviceSetName(deviceSetName);
                    authorityPageResp.setScheduleId(joinBeanScheduleId);
                    authorityPageResp.setScheduleUuid(scheduleUuid);
                    authorityPageResp.setScheduleName(scheduleName);
                    authorityPageResp.setGmtModified(gmtModified);
                    authorityPageResp.setGroups(new ArrayList<>());
                    resultMap.put(key, authorityPageResp);
                } else {
                    // 设置最新更新时间
                    Date gm = authorityPageResp.getGmtModified();
                    if (gm.before(gmtModified)) {
                        authorityPageResp.setGmtModified(gmtModified);
                    }
                }
                // 添加组
                authorityPageResp.getGroups().add(new AuthorityPageGroup(joinBeanGroupId, groupUuid, groupName));
            }
            ArrayList<AuthorityPageResp> result = new ArrayList<>(resultMap.values());
            log.info("排序前数据：{}", JSON.toJSONString(result));
            result.sort((o1, o2) -> {
                if (o1.getGmtModified().before(o2.getGmtModified())) {
                    return 1;
                } else if (o1.getGmtModified().after(o2.getGmtModified())) {
                    return -1;
                } else {
                    return 0;
                }
            });
            log.info("排序后数据：{}", JSON.toJSONString(result));
            return new PageData<>(pageData.getPageNum(), pageData.getPageSize(), pageData.getTotal(), result);
        }
        return new PageData<>();

    }

    @Override
    @PostMapping(value = "/api/v1/authority/queryDeviceAuthority")
    public List<PassDeviceAndSetResp> queryDeviceAuthority(@RequestBody PassBaseDeviceControlReq scheduleReq) {
        BaseDeviceControlReq baseDeviceControlReq = new BaseDeviceControlReq();
        BeanUtils.copyProperties(scheduleReq, baseDeviceControlReq);
        List<DeviceAndSetResp> deviceList = deviceApi.queryBaseDeviceControl(baseDeviceControlReq);
        if (CollectionUtils.isEmpty(deviceList)) {
            return Collections.emptyList();
        }
        Map<Long, DeviceAndSetResp> deviceSetMap = deviceList.stream()
            .collect(Collectors.toMap(DeviceAndSetResp::getDeviceSetId, item -> item, (v1, v2) -> v1));
        Set<Long> relationSet = new HashSet<>(relationService
            .queryDeviceAuthorityJoinSchedule(ScheduleTypeEnum.PASS.getType(), new ArrayList<>(deviceSetMap.keySet())));

        List<PassDeviceAndSetResp> reList = new ArrayList<>();
        deviceSetMap.keySet().forEach(item -> {
            if (relationSet.contains(item)) {
                DeviceAndSetResp resp = deviceSetMap.get(item);
                PassDeviceAndSetResp passDeviceAndSetResp = new PassDeviceAndSetResp();
                BeanUtils.copyProperties(resp, passDeviceAndSetResp);
                reList.add(passDeviceAndSetResp);
            }
        });
        return new ArrayList<>(reList.stream().collect(Collectors
            .toCollection(() -> new TreeSet<PassDeviceAndSetResp>(Comparator.comparing(PassDeviceAndSetResp::getId)))));
    }

    @Override
    public List<DeviceSetGroupScheduleResp> queryListByDeviceSet(@RequestBody AuthorityQueryReq authorityQueryReq) {
        List<DeviceSetGroupScheduleRelationEntity> relations =
            relationService.queryDeviceSets(null, authorityQueryReq.getDeviceIds(), null);
        List<DeviceSetGroupScheduleResp> resps = new ArrayList<>();
        if (CollectionUtils.isNotEmpty(relations)) {
            relations.forEach(relation -> {
                DeviceSetGroupScheduleResp resp = new DeviceSetGroupScheduleResp();
                BeanUtils.copyProperties(relation, resp);
                resps.add(resp);
            });
        }
        return resps;
    }

    /**
     * 根据条件查询设备组时间计划关系
     *
     * @param groupIdsReq
     * @return
     */
    @Override
    public List<DeviceSetGroupScheduleResp> queryListByGroupList(@RequestBody GroupIdsReq groupIdsReq) {
        List<DeviceSetGroupScheduleResp> resps = new ArrayList<>();
        List<Long> groupIds = groupIdsReq.getGroupIds();
        if (CollectionUtils.isNotEmpty(groupIds)) {
            List<DeviceSetGroupScheduleRelationEntity> relations =
                relationService.queryDeviceSets(groupIds, null, null);
            if (CollectionUtils.isNotEmpty(relations)) {
                relations.forEach(relation -> {
                    DeviceSetGroupScheduleResp resp = new DeviceSetGroupScheduleResp();
                    BeanUtils.copyProperties(relation, resp);
                    resps.add(resp);
                });
            }
        }
        return resps;
    }
}

```

