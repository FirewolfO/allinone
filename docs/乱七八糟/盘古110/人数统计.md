### 历史趋势

##### 数据库

###### 表结构

```sql
CREATE TABLE `chart_statistics_record_day` (
  `id` bigint(11) NOT NULL AUTO_INCREMENT COMMENT '主键、自增',
  `uuid` varchar(40) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'uuid',
  `zone_id` bigint(20) DEFAULT NULL COMMENT '区域ID',
  `zone_uuid` varchar(40) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '区域uuid',
  `chart_scene` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '图表场景',
  `count_type` int(11) DEFAULT NULL COMMENT '统计方式',
  `key1` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '一级分类key',
  `key2` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '二级分类key',
  `key3` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '三级分类key',
  `key4` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '四级分类key',
  `amount` bigint(20) DEFAULT NULL COMMENT '这次统计的数量',
  `timestamp` bigint(20) DEFAULT NULL COMMENT '时间戳标识',
  `day` int(11) DEFAULT NULL COMMENT '日',
  `month` int(11) DEFAULT NULL COMMENT '月',
  `year` int(11) DEFAULT NULL COMMENT '年',
  `gmt_create` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `gmt_modified` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=69310 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

###### 索引

```sql
ALTER TABLE `chart_statistics_check` ADD UNIQUE KEY unique_chart_statistics_record_day(`zone_id`,`chart_scene`,`key1`,`key2`,`key3`,`key4`,`timestamp`);
```



##### 定时任务

到时候需要更改表达式

```sql
insert into `task_scheduler` ( `task_scheduler_id`, `sys`, `owner_id`, `deal_type`, `type`, `source`, `cron_expression`, `define`, `params`, `timeout`, `time_unit`, `status`, `gmt_create`, `gmt_modified`) values('dashboard_statistics_day_total','3','0','1','3','0','0 0 3 * * ? ','dashboard_statistics_task_day_total','','5','3','0','2020-12-29 11:03:12','2020-12-29 11:03:15');
```

##### nacos

```properties
event.mq.chartTask.tags.daytotal=dashboard_statistics_task_day_total
```



历史趋势测试枚举，记得调整回去



1. jira状态
2. 插件化是否要合并到110
3. 106和插件化优先级
4. 110最终发版内容



### 新增事件类型

```sql
INSERT INTO `event_type` values (600,"35e69b505efe48518c71ca4afa875332","人数统计","personCount","6",0,"alarm_type_person_count","pangu,pangu_xinghe,pangu_haihe,pangu_yy",120,1,now(),now());
INSERT INTO `event_type` values (601,"b9947b82e6d54d13b4c7048c2a8531fa","人滞留超员报警","personRetention","6",600,"alarm_type_person_count","pangu,pangu_xinghe,pangu_haihe,pangu_yy",20,1,now(),now());
INSERT INTO `event_type` values (602,"660ddded9ce24ec7a3a649e0dbbff879","人数过密报警","personCountTooMany","6",600,"alarm_type_person_count","pangu,pangu_xinghe,pangu_haihe,pangu_yy",40,1,now(),now());
```

```
[alarm_type_border, dashboard_warning_mode, monitor_video, core_structure, security_model, core_capture, dashboard_main_mode, chinese, vehicle_num, alarm_type_action, ai_vedio, dashboard_control, zone_controll_model, high_frequency_model, dashboard_control_mode, pass_model, dashboard_pass_mode, core_alarm, alarm_type_border, person_num, dashboard_warning_mode, core_video, monitor_video, core_structure, security_model, core_capture, dashboard_main_mode, chinese, vehicle_num, alarm_type_action, alarm_type_border, dashboard_warning_mode, monitor_video, core_structure, security_model, core_capture, alarm_type_border, dashboard_main_mode, dashboard_warning_mode, monitor_video, chinese, core_structure, vehicle_num, security_model, alarm_type_action, ai_vedio, core_capture, dashboard_control, dashboard_main_mode, zone_controll_model, high_frequency_model, chinese, vehicle_num, dashboard_control_mode, pass_model, alarm_type_action, dashboard_pass_mode, ai_vedio, core_alarm, dashboard_control, zone_controll_model, person_num, high_frequency_model, ai_vedio, core_video, dashboard_control, dashboard_control_mode, zone_controll_model, pass_model, high_frequency_model, dashboard_pass_mode, dashboard_control_mode, pass_model, core_alarm, person_num, dashboard_pass_mode, core_video, core_alarm, person_num, core_video]
```



#### 事件联动设备列表方案

```sql
ALTER  TABLE event_rule_item MODIFY device_id varchar(30) DEFAULT NULL COMMENT '设备ID';
ALTER  TABLE event_rule_item MODIFY device_set_id varchar(30)  DEFAULT NULL COMMENT '设备setID';
```



```
2021-Aug-03 17:25:57.034 INFO  [ConsumeMessageThread_4] [TID:750338682e67448db2838a68fd67e206] com.megvii.ebg.pangu.common.mq.AbstractMqConsumer - BusiEventMqConsumer receive mq message = MMqMessage(topic=TP_busiEvent, body={"data":"{\"deviceName\":\"测试设备组222\",\"deviceType\":1,\"deviceUuid\":\"8df0b635f6674ea291372e563b4934c8\",\"personNumber\":865,\"recognitionTime\":1627982756000,\"type\":0,\"uuid\":\"750338682e67448db2838a68fd67e206\",\"zoneId\":1,\"zoneName\":\"一级区域\"}","deviceId":40,"deviceType":"1","eventTime":1627982756000,"eventType":701,"ext":"{}","trackId":"750338682e67448db2838a68fd67e206","zoneId":1}, tag=safeguard_busi_event_record, key=null, msgId=AC110001000820AD94180E0A50A00022, traceId=750338682e67448db2838a68fd67e206, reconsumeTimes=0)
```











