#### 工作记录

1. 110周晨会
2. 构建打包gitbook
3. 跟豪鑫沟通人数统计算法仓布控方式
   - 暂时按照16路混部测试，继续往上压；
   - 需要验证仅有密度布控情况下是否能到100路
4. 沟通算法仓部署、产品部署后续方式：
   - 后续把产品部署方式、算法仓部署方式（路数配比）写入prd，提前验证问题；
5. 预稳定性话环境B01升级B02
6. 算法仓部署方案重聊，结论如下：
   - 标准部署按照单卡20路办法、验证仅部署密度的时候的部署方式，是否能达到100路
7. bug修复
   - openAPI 数据推送 url 统一
   - 事件回调没有deviceUuid
   - 事件记录设备组筛选条件无效
   - 通行记录推送有id字段
   - 事件联动生产安监无设备
8. tts语音问题沟通，技术方案调整



#### oncall问题记录

1. 106全新部署使用的压缩包
2. 金风科技项目支持
   - 人员图片添加流程解答
   - 质量检测接口异常解答：没有图片
3. 金隅项目不产生通行记录
   - ES服务器硬盘满了，导致es自动修改调整index.blocks.read_only_allow_delete为true，索引只读，无法写入；
   - 排查发现es部署在了没有hdd的机器上，交付会跟产品提需求验证数据迁移方案；
   - 提供es数据迁移方案迁移数据
   - action：需要准备各种数据迁移方案
   - 结构化记录没有
     - 原因：索引别名丢失，重新设置别名即可
4. 



### es迁移方案调研

#### 粗暴迁移

1. 停止ai-converge服务
2. 拷贝原es所在机器上 /mnt/data/pangu/infra/es/data 到新的机器 ，新机器如果没有相应目录，请手动创建
3. 修改目录权限：sudo chmod -R 777  /mnt/data/pangu/infra/es
4. 导出pangu-safeguard-infra的yaml文件
   - 修改pangu-elasticsearch-master服务的hostname为新的主机名
   - 修改env 的network.publish_host和discovery.seed_hosts后面的主机为新的主机名
5. 重新导入yaml
6. 调整环境变量：ES_HOST  值改为新pangu-elasticsearch-master所在机器地址
7. 重启pangu-elasticsearch-master服务
8. 启动ai-converge服务
9. 重启所有盘古业务

> 结论：公司可以，现场失败



#### reindex方式

1. 新服务器搭建es服务

2. 停止业务及aiot服务

3. 编辑新服务器elasticsearch.yml配置文件

   - 拷贝容器配置文件到宿主机

     ```
     sudo docker cp es容器id：/usr/share/elasticsearch/config/elasticsearch.yml 宿主机目录
     ```

4. 编辑 

   vim  elasticsearch.yml，追加如下内容：

   ```
   reindex.remote.whitelist: "192.168.11.150:19200"
   ```

   后面是原es服务地址，注意whitelist:后面有空格

5. 修改新es挂载

   添加如下内容：

   宿主机elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

6. 重启新机器es容器

7. 在新机器创建重建索引脚本start.sh，内容如下：

   ```shell
   #!/bin/bash
   # $1:原服务器地址,$2:新服务器地址
   # 示例：./start.sh http://10.122.94.176:19200 http://192.11.11.11:19200
   echo $1  $2
   echo "">indexNames.txt
   curl -XGET $1/_cat/indices | awk -F ' ' '{print $3}' | egrep -v '^\.' > indexNames.txt
   for line in `cat indexNames.txt`
   do
   time=`date`
   echo "" > exe.log 
   echo "$time start reindex $line" >> exe.log
   curl -X POST "$2/_reindex?pretty" -H 'Content-Type: application/json' -d '{ "source": { "remote": { "host": ""'"$1"'""},"index": "'"$line"'"},"dest": {"index": "'"$line"'"}}'
   echo "$time finsh reindex $line" >> exe.log
   done
   echo "all success"
   ```

8. 执行脚本

   ```shell
   ./start.sh http://10.122.94.176:19200 http://192.11.11.11:19200
   ```

   可以在exe.log 中查看重建进度

>结论：现场成功

参考文档：

https://www.elastic.co/guide/en/elasticsearch/reference/current/reindex-upgrade-remote.html





#### es别名相关操作

##### 查看索引别名

```
GET structurized_face_202110/_alias
```

##### 批量添加别名

```
POST /_aliases

{
    "actions" : [

        { "add":{ "index" : "structurized_face_*", "alias" : "structurized_face" } },
				{ "add":{ "index" : "structurized_motor*", "alias" : "structurized_motor" } },
				{ "add":{ "index" : "structurized_nonmotor*", "alias" : "structurized_nonmotor" } },
				{ "add":{ "index" : "structurized_pedestrian*", "alias" : "structurized_pedestrian" } }
    ]

}
```

##### 批量删除别名

```
POST /_aliases
{
  "actions": [
    {
      "remove": {
        "index": "structurized_motor*",
        "alias": "structurized_face"
      }
    },
    {
      "remove": {
        "index": "structurized_nonmotor*",
        "alias": "structurized_face"
      }
    },
    {
      "remove": {
        "index": "structurized_pedestrian*",
        "alias": "structurized_face"
      }
    }
  ]
}

```







改端口路径问题

watch com.megvii.bbu.common.util.efs.EfsUtil generateAccessUrl "{params,returnObj}" -x 3

```
ts=2021-10-29 12:47:52; [cost=0.190434ms] result=@ArrayList[
    @Object[][
        @String[_ZzEwMF82bQ==_5c7cf2515f36448185f10a0104a14403],
        @Boolean[true],
        @Long[108000],
    ],
    @String[https://10.122.112.81/pub/_ZzEwMF82bQ==_5c7cf2515f36448185f10a0104a14403?timestamp=1635590872&sig=23951bdc46e8d1770fa3ec88582b5614],
]
```



@com.megvii.bbu.common.util.efs.EfsLocal.get() "{returnObj}"

null 



getstatic com.megvii.bbu.common.util.efs.EfsUtil EFS_FILE_SERVER_PUB

```
[arthas@7]$ getstatic com.megvii.bbu.common.util.efs.EfsUtil EFS_FILE_SERVER_PUB
field: EFS_FILE_SERVER_PUB
@String[https://10.122.112.81/]
Affect(row-cnt:1) cost in 19 ms.
```

```java
       public static String generateAccessUrl(String fileKey, boolean accessFromPub, long expireTime) {
/*135*/     if (StringUtil.isEmpty((String)fileKey) || fileKey.startsWith("http")) {
/*136*/         if (StringUtil.isEmpty((String)fileKey)) {
/*137*/             return fileKey;
                }
/*140*/         if (accessFromPub) {
/*141*/             URI uri = URI.create(fileKey);
/*142*/             int port = uri.getPort();
/*143*/             String pubScheme = HttpsLocal.get();
/*144*/             if (StringUtil.isEmpty((String)pubScheme)) {
/*145*/                 log.error("EfsUtil对外完整URL替换错误，accessFromPub=true且HttpsLocal为空，fileKey={}", (Object)fileKey);
                    } else {
/*148*/                 String newPort = pubScheme.equals("https") ? HTTPS_PORT : HTTP_PORT;
/*150*/                 fileKey = -1 == port ? fileKey.replace(uri.getScheme() + "://" + uri.getHost(), pubScheme + "://" + uri.getHost() + ":" + newPort) : fileKey.replace(uri.getScheme() + "://" + uri.getHost() + ":" + port, pubScheme + "://" + uri.getHost() + ":" + newPort);
                    }
                }
/*160*/         return fileKey;
            }
            StringBuilder urlBuilder = new StringBuilder();
/*163*/     if (accessFromPub) {
/*165*/         if (EfsLocal.get() != null) {
/*167*/             if (!"https".equals(HttpsLocal.get())) {
/*168*/                 urlBuilder.append("http://");
                    } else {
/*170*/                 urlBuilder.append("https://");
                    }
/*172*/             urlBuilder.append(EfsLocal.get().replace("/", ""));
/*174*/             if (!"https".equals(HttpsLocal.get())) {
/*175*/                 if (!"80".equals(HTTP_PORT)) {
/*176*/                     urlBuilder.append(":" + HTTP_PORT);
                        }
/*179*/             } else if (!"443".equals(HTTPS_PORT)) {
/*180*/                 urlBuilder.append(":" + HTTPS_PORT);
                    }
/*183*/             urlBuilder.append("/");
                } else {
/*185*/             String pubAddress = EFS_FILE_SERVER_PUB;
/*186*/             URI uri = URI.create(pubAddress);
/*187*/             String path = uri.getPath();
/*188*/             String host = uri.getHost();
/*190*/             String scheme = StringUtil.isEmpty((String)HttpsLocal.get()) ? uri.getScheme() : HttpsLocal.get();
                    String addrFormat = "%s://" + host + "%s" + path;
/*193*/             pubAddress = "http".equals(scheme) ? String.format(addrFormat, scheme, "80".equals(HTTP_PORT) ? "" : ":" + HTTP_PORT) : String.format(addrFormat, scheme, "443".equals(HTTPS_PORT) ? "" : ":" + HTTPS_PORT);
/*199*/             urlBuilder.append(pubAddress);
/*200*/             log.info("EfsUtil拼接pubAddress，accessFromPub=true且EfsLocal为空，取EFS_FILE_SERVER_PUB配置");
                }
/*202*/         urlBuilder.append("pub/");
            } else {
/*204*/         urlBuilder.append(EFS_FILE_SERVER_PRI);
/*205*/         urlBuilder.append("pri/");
            }
/*207*/     urlBuilder.append(fileKey);
/*208*/     if (accessFromPub) {
/*209*/         long timestamp = System.currentTimeMillis() / 1000L + expireTime;
/*210*/         urlBuilder.append("?timestamp=").append(timestamp);
/*211*/         urlBuilder.append("&sig=").append(EfsUtil.calcSig(fileKey, timestamp));
            }
/*214*/     return urlBuilder.toString();
        }
```

  



```java
arthas@7]$ 
[arthas@7]$ jad com.megvii.bbu.common.util.efs.EfsUtil

ClassLoader:                                                                                                                                                                                                                        
+-org.springframework.boot.loader.LaunchedURLClassLoader@20ad9418                                                                                                                                                                   
  +-sun.misc.Launcher$AppClassLoader@55f96302                                                                                                                                                                                       
    +-sun.misc.Launcher$ExtClassLoader@30d07c8f                                                                                                                                                                                     

Location:                                                                                                                                                                                                                           
file:/opt/project/pangu-ms-passrecord-1.0.6-test-SNAPSHOT-exec.jar!/BOOT-INF/lib/common-util-1.0.5-SNAPSHOT.jar!/                                                                                                                   

        /*
         * Decompiled with CFR.
         * 
         * Could not load the following classes:
         *  com.alibaba.fastjson.JSONArray
         *  com.alibaba.fastjson.JSONObject
         *  com.google.common.collect.Lists
         *  com.megvii.bbu.common.util.DigestUtil
         *  com.megvii.bbu.common.util.StringUtil
         *  com.megvii.bbu.common.util.UuidUtil
         *  com.megvii.bbu.common.util.bone.MegviiCommonErrorCode
         *  com.megvii.bbu.common.util.bone.MegviiErrorCode
         *  com.megvii.bbu.common.util.bone.MegviiException
         *  com.megvii.bbu.common.util.efs.EfsLocal
         *  com.megvii.bbu.common.util.efs.HttpsLocal
         *  com.megvii.bbu.common.util.http.okhttp.OkHttpUtil
         *  org.apache.commons.lang3.StringUtils
         *  org.slf4j.Logger
         *  org.slf4j.LoggerFactory
         */
        package com.megvii.bbu.common.util.efs;
        
        import com.alibaba.fastjson.JSONArray;
        import com.alibaba.fastjson.JSONObject;
        import com.google.common.collect.Lists;
        import com.megvii.bbu.common.util.DigestUtil;
        import com.megvii.bbu.common.util.StringUtil;
        import com.megvii.bbu.common.util.UuidUtil;
        import com.megvii.bbu.common.util.bone.MegviiCommonErrorCode;
        import com.megvii.bbu.common.util.bone.MegviiErrorCode;
        import com.megvii.bbu.common.util.bone.MegviiException;
        import com.megvii.bbu.common.util.efs.EfsLocal;
        import com.megvii.bbu.common.util.efs.HttpsLocal;
        import com.megvii.bbu.common.util.http.okhttp.OkHttpUtil;
        import java.io.File;
        import java.io.FileInputStream;
        import java.io.FileOutputStream;
        import java.io.IOException;
        import java.io.InputStream;
        import java.io.OutputStream;
        import java.net.URI;
        import java.util.HashMap;
        import java.util.stream.Collectors;
        import org.apache.commons.lang3.StringUtils;
        import org.slf4j.Logger;
        import org.slf4j.LoggerFactory;
        
        public class EfsUtil {
            private static final Logger log = LoggerFactory.getLogger(EfsUtil.class);
            private static String EFS_FILE_SERVER_PUB;
            private static String EFS_FILE_SERVER_PRI;
            private static String EFS_FILE_SERVER_SECRET;
            private static String HTTP_PORT;
            private static String HTTPS_PORT;
            private static final String SIG_FORMAT = "%s&%s&%s";
        
            static {
/* 38*/         HTTP_PORT = "80";
/* 41*/         HTTPS_PORT = "443";
/* 47*/         EFS_FILE_SERVER_SECRET = System.getenv("EFS_FILE_SERVER_SECRET");
/* 48*/         String EFS_FILE_SERVER = EfsUtil.parseEnvUrl("EFS_FILE_SERVER", "");
/* 50*/         EFS_FILE_SERVER_PUB = EfsUtil.parseEnvUrl("EFS_FILE_SERVER_PUB", EFS_FILE_SERVER);
/* 51*/         EFS_FILE_SERVER_PRI = EfsUtil.parseEnvUrl("EFS_FILE_SERVER_PRI", EFS_FILE_SERVER);
            }
        
            public static void main(String[] args) throws Exception {
/*474*/         String a = EfsUtil.generateAccessUrl("123");
            }
        
            public static void initEfsFileServer(String efsFileServerPub, String efsFileServerPri, String efsFileServerSrecet, String httpPort, String httpsPort) {
/* 76*/         if (!efsFileServerPub.endsWith("/")) {
                    efsFileServerPub = efsFileServerPub + "/";
                }
/* 79*/         if (!efsFileServerPri.endsWith("/")) {
                    efsFileServerPri = efsFileServerPri + "/";
                }
/* 82*/         EFS_FILE_SERVER_PUB = efsFileServerPub;
/* 83*/         EFS_FILE_SERVER_PRI = efsFileServerPri;
/* 84*/         EFS_FILE_SERVER_SECRET = efsFileServerSrecet;
/* 86*/         HTTP_PORT = httpPort;
/* 87*/         HTTPS_PORT = httpsPort;
            }
        
            public static void initEfsFileServer(String efsFileServerPub, String efsFileServerPri, String efsFileServerSrecet) {
/* 98*/         if (!efsFileServerPub.endsWith("/")) {
                    efsFileServerPub = efsFileServerPub + "/";
                }
/*101*/         if (!efsFileServerPri.endsWith("/")) {
                    efsFileServerPri = efsFileServerPri + "/";
                }
/*104*/         EFS_FILE_SERVER_PUB = efsFileServerPub;
/*105*/         EFS_FILE_SERVER_PRI = efsFileServerPri;
/*106*/         EFS_FILE_SERVER_SECRET = efsFileServerSrecet;
/*109*/         String port = System.getenv(HTTP_PORT);
/*110*/         if (StringUtils.isNotEmpty((CharSequence)port)) {
/*111*/             HTTP_PORT = port;
                }
/*113*/         if (StringUtils.isNotEmpty((CharSequence)(port = System.getenv(HTTPS_PORT)))) {
/*115*/             HTTPS_PORT = port;
                }
            }
        
            public static String upload(byte[] data, long expireTime, String filename) throws IOException {
/*308*/         return EfsUtil.upload(data, null, expireTime, filename);
            }
        
            public static String upload(byte[] data, String filename) throws IOException {
/*287*/         return EfsUtil.upload(data, 0L, filename);
            }
        
            public static String upload(byte[] data) throws IOException {
/*276*/         return EfsUtil.upload(data, 0L);
            }
        
            public static String upload(byte[] data, InputStream is, long expireTime) throws IOException {
/*343*/         return EfsUtil.upload(data, is, expireTime, null);
            }
        
            public static String upload(byte[] data, InputStream is, long expireTime, String filename) throws IOException {
                StringBuilder urlBuilder = new StringBuilder();
/*354*/         expireTime = expireTime > 0L ? System.currentTimeMillis() / 1000L + expireTime : 0L;
/*360*/         urlBuilder.append(EFS_FILE_SERVER_PRI + "pri/upload?exp_time=").append(expireTime);
/*361*/         if (!StringUtil.isEmpty((String)filename)) {
/*362*/             urlBuilder.append("&filename=").append(filename);
                }
/*365*/         String url = urlBuilder.toString();
                HashMap<String, Object> fileMap = new HashMap<String, Object>();
/*367*/         if (data == null) {
/*368*/             fileMap.put("file", is);
                } else {
/*370*/             fileMap.put("file", data);
                }
/*372*/         String rr = OkHttpUtil.getInstance().doPostFormMultipart2(url, null, fileMap);
/*373*/         JSONObject retObj = JSONObject.parseObject((String)rr);
/*374*/         if (retObj.getJSONObject("data") != null) {
/*375*/             return retObj.getJSONObject("data").getString("filename");
                }
                throw new IOException("文件上传失败");
            }
        
            public static String upload(byte[] data, long expireTime) throws IOException {
/*296*/         return EfsUtil.upload(data, expireTime, null);
            }
        
            public static String upload(InputStream is) throws IOException {
/*245*/         return EfsUtil.upload(is, 0);
            }
        
            public static String upload(InputStream is, String filename) throws IOException {
/*248*/         return EfsUtil.upload(is, 0, filename);
            }
        
            public static String upload(InputStream is, int expireTime, String filename) throws IOException {
/*268*/         return EfsUtil.upload(null, is, expireTime, filename);
            }
        
            public static String upload(InputStream is, int expireTime) throws IOException {
/*257*/         return EfsUtil.upload(is, expireTime, null);
            }
        
            public static String generateAccessUrl(String fileKey) {
/*125*/         return EfsUtil.generateAccessUrl(fileKey, true, 604800L);
            }
        
            public static String generateAccessUrl(String fileKey, boolean accessFromPub, long expireTime) {
/*135*/         if (StringUtil.isEmpty((String)fileKey) || fileKey.startsWith("http")) {
/*136*/             if (StringUtil.isEmpty((String)fileKey)) {
/*137*/                 return fileKey;
                    }
/*140*/             if (accessFromPub) {
/*141*/                 URI uri = URI.create(fileKey);
/*142*/                 int port = uri.getPort();
/*143*/                 String pubScheme = HttpsLocal.get();
/*144*/                 if (StringUtil.isEmpty((String)pubScheme)) {
/*145*/                     log.error("EfsUtil对外完整URL替换错误，accessFromPub=true且HttpsLocal为空，fileKey={}", (Object)fileKey);
                        } else {
/*148*/                     String newPort = pubScheme.equals("https") ? HTTPS_PORT : HTTP_PORT;
/*150*/                     fileKey = -1 == port ? fileKey.replace(uri.getScheme() + "://" + uri.getHost(), pubScheme + "://" + uri.getHost() + ":" + newPort) : fileKey.replace(uri.getScheme() + "://" + uri.getHost() + ":" + port, pubScheme + "://" + uri.getHost() + ":" + newPort);
                        }
                    }
/*160*/             return fileKey;
                }
                StringBuilder urlBuilder = new StringBuilder();
/*163*/         if (accessFromPub) {
/*165*/             if (EfsLocal.get() != null) {
/*167*/                 if (!"https".equals(HttpsLocal.get())) {
/*168*/                     urlBuilder.append("http://");
                        } else {
/*170*/                     urlBuilder.append("https://");
                        }
/*172*/                 urlBuilder.append(EfsLocal.get().replace("/", ""));
/*174*/                 if (!"https".equals(HttpsLocal.get())) {
/*175*/                     if (!"80".equals(HTTP_PORT)) {
/*176*/                         urlBuilder.append(":" + HTTP_PORT);
                            }
/*179*/                 } else if (!"443".equals(HTTPS_PORT)) {
/*180*/                     urlBuilder.append(":" + HTTPS_PORT);
                        }
/*183*/                 urlBuilder.append("/");
                    } else {
/*185*/                 String pubAddress = EFS_FILE_SERVER_PUB;
/*186*/                 URI uri = URI.create(pubAddress);
/*187*/                 String path = uri.getPath();
/*188*/                 String host = uri.getHost();
/*190*/                 String scheme = StringUtil.isEmpty((String)HttpsLocal.get()) ? uri.getScheme() : HttpsLocal.get();
                        String addrFormat = "%s://" + host + "%s" + path;
/*193*/                 pubAddress = "http".equals(scheme) ? String.format(addrFormat, scheme, "80".equals(HTTP_PORT) ? "" : ":" + HTTP_PORT) : String.format(addrFormat, scheme, "443".equals(HTTPS_PORT) ? "" : ":" + HTTPS_PORT);
/*199*/                 urlBuilder.append(pubAddress);
/*200*/                 log.info("EfsUtil拼接pubAddress，accessFromPub=true且EfsLocal为空，取EFS_FILE_SERVER_PUB配置");
                    }
/*202*/             urlBuilder.append("pub/");
                } else {
/*204*/             urlBuilder.append(EFS_FILE_SERVER_PRI);
/*205*/             urlBuilder.append("pri/");
                }
/*207*/         urlBuilder.append(fileKey);
/*208*/         if (accessFromPub) {
/*209*/             long timestamp = System.currentTimeMillis() / 1000L + expireTime;
/*210*/             urlBuilder.append("?timestamp=").append(timestamp);
/*211*/             urlBuilder.append("&sig=").append(EfsUtil.calcSig(fileKey, timestamp));
                }
/*214*/         return urlBuilder.toString();
            }
        
            private static String parseEnvUrl(String envKey, String defaultValue) {
/* 55*/         String value = System.getenv(envKey);
/* 56*/         if (StringUtil.isEmpty((String)value)) {
/* 57*/             value = defaultValue;
/* 59*/         } else if (!value.endsWith("/")) {
                    value = value + "/";
                }
/* 63*/         return value;
            }
        
            @Deprecated
            private static String uploadDummy(byte[] data, long expireTime) throws IOException {
                String tmpDir = System.getProperty("java.io.tmpdir");
/*437*/         if (!tmpDir.endsWith("/")) {
                    tmpDir = tmpDir + "/";
                }
/*440*/         String fileName = UuidUtil.generateUuid();
                String filePath = tmpDir + fileName;
                try (FileOutputStream os = new FileOutputStream(filePath);){
/*443*/             ((OutputStream)os).write(data);
/*444*/             os.flush();
                }
/*447*/         return fileName;
            }
        
            @Deprecated
            private static byte[] downloadDummy(String fileKey) throws IOException {
                String tmpDir = System.getProperty("java.io.tmpdir");
/*459*/         if (!tmpDir.endsWith("/")) {
                    tmpDir = tmpDir + "/";
                }
                String filePath = tmpDir + fileKey;
                try (FileInputStream is = new FileInputStream(filePath);){
/*464*/             int len = ((InputStream)is).available();
/*465*/             byte[] data = new byte[len];
/*466*/             ((InputStream)is).read(data);
/*467*/             byte[] byArray = data;
/*467*/             return byArray;
                }
            }
        
            public static String generateAccessUrlNotWithHostAndPort(String fileKey, boolean accessFromPub, long expireTime) {
/*225*/         if (StringUtil.isEmpty((String)fileKey) || fileKey.startsWith("http")) {
/*226*/             return fileKey;
                }
                StringBuilder urlBuilder = new StringBuilder();
/*229*/         urlBuilder.append(fileKey);
/*230*/         if (accessFromPub) {
/*231*/             long timestamp = System.currentTimeMillis() / 1000L + expireTime;
/*232*/             urlBuilder.append("?timestamp=").append(timestamp);
/*233*/             urlBuilder.append("&sig=").append(EfsUtil.calcSig(fileKey, timestamp));
                }
/*236*/         return urlBuilder.toString();
            }
        
            public static byte[] download(String fileKey) throws IOException {
/*318*/         return OkHttpUtil.getInstance().doGetbytes(EFS_FILE_SERVER_PRI + "pri/" + fileKey);
            }
        
            public static void downloadWithFile(String fileKey, File file) throws Exception {
/*322*/         OkHttpUtil.getInstance().doGetFile(EFS_FILE_SERVER_PRI + "pri/" + fileKey, file);
            }
        
            private static String calcSig(String filename, long timestamp) {
/*334*/         return DigestUtil.encryptMd5((String)String.format(SIG_FORMAT, timestamp, filename, EFS_FILE_SERVER_SECRET));
            }
        
            public static String[] deleteFiles(boolean sync, String ... files) {
/*391*/         if (files == null || files.length == 0) {
/*392*/             return new String[0];
                }
/*394*/         if (files.length > 100) {
                    throw new MegviiException((MegviiErrorCode)MegviiCommonErrorCode.PARAM_INVALID);
                }
                StringBuilder urlBuilder = new StringBuilder(EFS_FILE_SERVER_PRI);
/*399*/         urlBuilder.append("files/");
/*400*/         if (sync) {
/*401*/             urlBuilder.append("sync");
                } else {
/*403*/             urlBuilder.append("async");
                }
                JSONObject filesJson = new JSONObject();
/*406*/         filesJson.put("filenames", (Object)Lists.newArrayList((Object[])files));
/*407*/         String rr = OkHttpUtil.getInstance().doDeleteJson(urlBuilder.toString(), filesJson.toJSONString());
/*408*/         JSONObject retObj = JSONObject.parseObject((String)rr);
/*409*/         if (retObj.getIntValue("code") == 0) {
                    JSONArray jsonArray;
/*410*/             if (retObj.getJSONObject("data") != null && (jsonArray = retObj.getJSONObject("data").getJSONArray("failed_filenames")) != null && !jsonArray.isEmpty()) {
/*413*/                 String[] ress = new String[jsonArray.size()];
/*414*/                 jsonArray.stream().map(t -> t.toString()).collect(Collectors.toList()).toArray(ress);
/*415*/                 return ress;
                    }
/*418*/             return new String[0];
                }
                throw new MegviiException((MegviiErrorCode)MegviiCommonErrorCode.SYSTEM_ERROR);
            }
        }
```

