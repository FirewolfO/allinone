## 打包

### 盘古

- 在http://helper.pangu.megvii-inc.com/project/4/pangu-pangu-1.0.2-mainLine-test/detail/page 下载对应版本的tar包
- 压缩：pixz  xxx.tar  xxx.tar.xz



达尔文



Core









## 上传

- 在SDC下载上传工具sdc-upload-linux，并放到打包使用的服务器

- 为sdc-upload-linux添加执行权限

- 执行下面的命令上传

  ```
  sudo ./sdc-upload-linux -k appKey -p SDC上的地址 文件名 &
  ```





背景：

加密狗异常重启的时候，物品仓挂掉



沟通：

1. 狗重启完成之后，R能够重启物品仓；

   

R 评估结论：

我们评估了一下，这个问题的确还比较重要，所以抽调了部分人力来解决这个问题。但是我们讨论了技术方案后，感觉目前的代码不是特别好改，改完可能还会产生别的风险。我们评估的结论是14号之前可以解决这个问题。



发版时间：14号

评估：

1. 不修改Core：RC 物品P0 case 回归 + 物品离线包验证 （1天）
2. 修改Core：

风险：无法保证已测性能指标仍然满足；



Action：

1. R提供模拟方式
2. 是否会修改demod
3. 方案 + changeLog  
4. 根据changeLog评估是否需要回归p1 p2 相关case





流程：

1. 开发尾期：增加一个开发+测试相互的case review阶段
2. 技术方案评审是否多阶段，适合于测试+产品的技术方案评审方式。
3. 测试思考一下测试case的评审方案；
4. 提前交流测试case和技术方案，让相关同学提前感知，带着问题去参加评审；





1、加密狗重启问题：开发专题解决

2、脸人绑定延迟是否有优化空间



Core



```
docker save -o core.classic-5.8-2021.01-patch1.pangu.custom.tar ampregistry:5000/screlease:pangu.custom-20211111_5.8-2021.01-release.ebg-dac3e80f-build702155.ebg 
```



### 前置依赖

#### 注意事项

- 不可以切换到sudo su 进行打包

#### 环境准备

- 安装pv 和pixz

  ```shell
  sudo wget http://ftp.sjtu.edu.cn/ubuntu/pool/universe/p/pixz/pixz_1.0.7-1_amd64.deb 
  sudo dpkg -i pixz_1.0.7-1_amd64.deb
  sudo wget http://ftp.sjtu.edu.cn/ubuntu/pool/universe/p/pv/pv_1.6.0-1_amd64.deb
  sudo dpkg -i pv_1.6.0-1_amd64.deb
  ```

  

#### 下载镜像pull.sh

- 把core的镜像信息放到images.txt中

- ./pull.sh images.txt

  ```
  #!/bin/bash 
  for i in `cat $1 | tr " " "\n"`
  do
          sudo docker pull $i
  done
  ```

  

ampregistry:5000/megalarm:release_prod_101_3.1.1_81328297_soft-enc

### Core

core=hard_image	hard_name	soft_image	soft_name	otherimages

```shell
function packageCore
{
	coreInfos=(`cat $imageInfoFile | grep "core=" | tr "\t"`)
	echo ${coreInfos[@]}
}

```



sudo docker save ampregistry:5000/crowd-count:c5434c8_fix-e64742bb-build373457  | pv | pixz | pv > crowd-count_c5434c8_fix-e64742bb-build373457.soft.tar.xz

软狗：

```shell
docker save ampregistry:5000/kafka-exporter:v1.2.0.debug.66251851 ampregistry:5000/weed:release-weed.5.ha-c690af86-build433041 ampregistry:5000/jaegertracing-all-in-one:1.20 ampregistry:5000/iot-weed:GSP-V1.1-1.45-d21084c7-build318205 ampregistry:5000/bigdata-postgresql-11.5:v2.5.20201111 ampregistry:5000/grafana:7.1.0.megvii-ipu.plugins ampregistry:5000/kafka:2.11-2.0.0.181225 ampregistry:5000/camera-proxy:v2.2.0-bb3f1996-build266045 ampregistry:5000/etcd:v3.4.2 ampregistry:5000/bigdata-clickhouse-20.3:v1.0.20200819 ampregistry:5000/profilo-tool:v1.0.20101322 ampregistry:5000/bigdata-postgresql-10.6:v1.4.20190228 ampregistry:5000/prom_node_exporter:latest ampregistry:5000/redis:5.0.5-alpine ampregistry:5000/zetcd:v0.0.5-d557351b495a60a68069af57c61ee0b6d6abb158 ampregistry:5000/sng-biz-cassandra:3.11.5.1912272158-bf65c2f9-release ampregistry:5000/pushgateway:v1.1.0 ampregistry:5000/elasticsearch:7.6.2-int8 ampregistry:5000/prometheus:v2.19.3 ampregistry:5000/bigdata-postgres_exporter_v0.5.1:v1.0.20190915 ampregistry:5000/screlease:pangu.custom-20211111_5.8-2021.01-release.softdog.ebg-dac3e80f-build723307.soft.ebg  | pv | pixz | pv > core.classic-5.8-2021.01-patch1.softdog.ebg.custom.tar.xz
```

硬狗：

```shell
docker save ampregistry:5000/kafka-exporter:v1.2.0.debug.66251851 ampregistry:5000/weed:release-weed.5.ha-c690af86-build433041 ampregistry:5000/jaegertracing-all-in-one:1.20 ampregistry:5000/iot-weed:GSP-V1.1-1.45-d21084c7-build318205 ampregistry:5000/bigdata-postgresql-11.5:v2.5.20201111 ampregistry:5000/grafana:7.1.0.megvii-ipu.plugins ampregistry:5000/kafka:2.11-2.0.0.181225 ampregistry:5000/camera-proxy:v2.2.0-bb3f1996-build266045 ampregistry:5000/etcd:v3.4.2 ampregistry:5000/bigdata-clickhouse-20.3:v1.0.20200819 ampregistry:5000/profilo-tool:v1.0.20101322 ampregistry:5000/bigdata-postgresql-10.6:v1.4.20190228 ampregistry:5000/prom_node_exporter:latest ampregistry:5000/redis:5.0.5-alpine ampregistry:5000/zetcd:v0.0.5-d557351b495a60a68069af57c61ee0b6d6abb158 ampregistry:5000/sng-biz-cassandra:3.11.5.1912272158-bf65c2f9-release ampregistry:5000/pushgateway:v1.1.0 ampregistry:5000/elasticsearch:7.6.2-int8 ampregistry:5000/prometheus:v2.19.3 ampregistry:5000/bigdata-postgres_exporter_v0.5.1:v1.0.20190915 ampregistry:5000/screlease:pangu.custom-20211111_5.8-2021.01-release.ebg-dac3e80f-build723307.soft.ebg | pv | pixz | pv > core.classic-5.8-2021.01-patch1.ebg.custom.tar.xz
```





```
export ROOT_DIR=/home/gaoying/coreall
sudo chmod -R 777 $ROOT_DIR
sudo devops-svcctl dpkg-dump --image ampregistry:5000/screlease:core.classic-5.8-2021.01-patch1-6a9a30f8-build514000 --manifest /devops-volumes/devops.model.json --save $ROOT_DIR/artifact ||  (echo "不包含数据包，生成完毕." ; exit 1)

sudo ls $ROOT_DIR/artifact/data-*.devops_dpkg | xargs -n 1 -P 32 md5sum >> $ROOT_DIR/artifact/devops_dpkg_md5
DPKG_NAME=`basename $ROOT_DIR/artifact/data-*.devops_dpkg`


cd $ROOT_DIR 
mkdir hard.ebg.x86-64
sudo tar cvf $ROOT_DIR/hard.ebg.x86-64/core.classic-5.8-2021.01-patch1.ebg.custom.devops_release_pkg -C  $ROOT_DIR/hard.ebg.x86-64 core.classic-5.8-2021.01-patch1.ebg.custom.tar.xz -C  $ROOT_DIR/artifact $DPKG_NAME

cd $ROOT_DIR
sudo mdkir soft.ebg.x86-64
sudo tar cvf $ROOT_DIR/soft.ebg.x86-64/core.classic-5.8-2021.01-patch1.softdog.ebg.custom.devops_release_pkg -C $ROOT_DIR/soft.ebg.x86-64 core.classic-5.8-2021.01-patch1.softdog.ebg.custom.tar.xz -C  $ROOT_DIR/artifact $DPKG_NAME
```



### 警戒

```shell
sudo docker pull ampregistry:5000/megalarm:release_prod_101_3.1.1_81328297_hard-enc
sudo docker save -o release_prod_101_3.1.1_81328297_hard-enc.tar ampregistry:5000/megalarm:release_prod_101_3.1.1_81328297_hard-enc


sudo docker pull ampregistry:5000/megalarm:release_prod_101_3.1.1_81328297_soft-enc
sudo docker save -o release_prod_101_3.1.1_81328297_soft-enc.tar ampregistry:5000/megalarm:release_prod_101_3.1.1_81328297_soft-enc

```



### 安监

```shell
sudo docker pull ampregistry:5000/super-safety-mainline-f90394e-20210825-hard-enc:v1.0.1
sudo docker save -o super-safety-mainline-f90394e-20210825-hard-enc_v1.0.1.tar ampregistry:5000/super-safety-mainline-f90394e-20210825-hard-enc:v1.0.1

sudo docker pull ampregistry:5000/super-safety-mainline-f90394e-20210825-soft-enc:v1.0.1
sudo docker save -o super-safety-mainline-f90394e-20210825-soft-enc_v1.0.1.tar ampregistry:5000/super-safety-mainline-f90394e-20210825-soft-enc:v1.0.1

sudo docker pull ampregistry:5000/super-safety-mainline-f90394e-20210825-noenc:v1.0.1
sudo docker save -o super-safety-mainline-f90394e-20210825-noenc_v1.0.1.tar ampregistry:5000/super-safety-mainline-f90394e-20210825-noenc:v1.0.1
```



### 物品

```shell
sudo docker pull ampregistry:5000/goods:release_prod_102_1.1.2_hotfix1_919cf34_hard-enc
sudo docker save -o goods_release_prod_102_1.1.2_hotfix1_919cf34_hard-enc.tar ampregistry:5000/goods:release_prod_102_1.1.2_hotfix1_919cf34_hard-enc


sudo docker pull ampregistry:5000/goods:release_prod_102_1.1.2_hotfix1_919cf34_soft-enc 
sudo docker save -o goods_release_prod_102_1.1.2_hotfix1_919cf34_soft-enc.tar ampregistry:5000/goods:release_prod_102_1.1.2_hotfix1_919cf34_soft-enc 

sudo docker pull ampregistry:5000/goods:release_prod_102_1.1.2_hotfix2_c78fead_hard-enc
sudo docker save ampregistry:5000/goods:release_prod_102_1.1.2_hotfix2_c78fead_hard-enc | pv | pixz | pv >  goods_release_prod_102_1.1.2_hotfix2_c78fead_hard-enc.tar.xz

sudo docker pull ampregistry:5000/goods:release_prod_102_1.1.2_hotfix2_c78fead_soft-enc
sudo docker save ampregistry:5000/goods:release_prod_102_1.1.2_hotfix2_c78fead_soft-enc | pv | pixz | pv >  goods_release_prod_102_1.1.2_hotfix2_c78fead_soft-enc.tar.xz
```



```shell
sudo docker save ampregistry:5000/crowd-count:dev-ed490e69-build332080 | pv | pixz | pv > crowd-count_dev-ed490e69-build332080.tar.xz 
```

```
sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/人数算法仓/   crowd-count_dev-ed490e69-build332080.tar.xz & 
```



### 人数

```shell
sudo docker pull ampregistry:5000/crowd-count:dev-6b38910c-build324307
sudo docker save -o crowd-count_dev-6b38910c-build324307.tar ampregistry:5000/crowd-count:dev-6b38910c-build324307
```



### 上传

```shell
sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/人数算法仓/   crowd-count_c5434c8_fix-e64742bb-build373457.soft.tar.xz & 

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/安监算法仓/  super-safety-mainline-f90394e-20210825-hard-enc_v1.0.1.tar.xz & 

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/安监算法仓/  super-safety-mainline-f90394e-20210825-soft-enc_v1.0.1.tar.xz  & 

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/安监算法仓/  super-safety-mainline-f90394e-20210825-noenc_v1.0.1.tar.xz  & 


sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/物品算法仓/ goods_release_prod_102_1.1.2_hotfix1_919cf34_hard-enc.tar.xz & 

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/物品算法仓/  goods_release_prod_102_1.1.2_hotfix1_919cf34_soft-enc.tar.xz & 

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/物品算法仓/ goods_release_prod_102_1.1.2_hotfix2_c78fead_hard-enc.tar.xz &

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/物品算法仓/ goods_release_prod_102_1.1.2_hotfix2_c78fead_soft-enc.tar.xz &

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/警戒算法仓/  release_prod_101_3.1.1_81328297_hard-enc.tar.xz &

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/警戒算法仓/  release_prod_101_3.1.1_81328297_soft-enc.tar.xz &

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/pangu/ pangu_docker_pangu_V1.1.0.RC01.tar.xz & 


sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/Core /home/gaoying/coreall/hard.ebg.x86-64/core.classic-5.8-2021.01-patch1.ebg.custom.devops_release_pkg &

sudo ./sdc-upload-linux -k eyJpZCI6MjQzfQ.E2e6Dw.tCYxnVpNfzLIhh4bcxbEPISNlII -p EBG发布版本/盘古/test版本/主线版本/V1.1.0/V1.1.0.RC01/Core /home/gaoying/coreall/soft.ebg.x86-64/core.classic-5.8-2021.01-patch1.softdog.ebg.custom.devops_release_pkg & 
```



pangu.txt

```shell
name url
```



```shell
# $1 image镜像文件
if[[ -n $1 ]]; then
	echo "no image info file, please try again !"
	exit 0
fi

# 检查并安装 pv & pixz  for core package
function soft_check_install()
{
	#pv
	pv=`sudo dpkg -l | grep pv | wc -l`
	if [ $pv == '0' ];then
		echo "no pv , start install"
		sudo wget http://ftp.sjtu.edu.cn/ubuntu/pool/universe/p/pv/pv_1.6.0-1_amd64.deb
    	sudo dpkg -i pv_1.6.0-1_amd64.deb
	fi
	
	#pixz
	pixz=`sudo dpkg -l | grep pixz | wc -l`
	if [ $pixz == '0' ];then
		sudo wget http://ftp.sjtu.edu.cn/ubuntu/pool/universe/p/pixz/pixz_1.0.7-1_amd64.deb 
    	sudo dpkg -i pixz_1.0.7-1_amd64.deb
    fi
}
soft_check_install

# 上传到sdc
function uploadSDC()
{
	uploadShInfo=(`cat $uploadShInfoFile | tr " " `)
	shellName=${uploadShInfo[0]}
	sdcKey=${uploadShInfo[1]}
	path=$1
	file=$2
	sudo ./$1 -k sdcKey -p $1 $2 & 
}

function processPangu()
{
	if [ -n panguInfoFile ]; then 
        panguinfo=(`cat $panguInfoFile | tr " "`)
        echo "panguInfo=${panguInfo[@]}"
        sudo wget ${panguinfo[0]} | ${panguinfo[1]}.xz
        upload ${panguinfo[2]} ${panguinfo[1]}.xz
     fi
}

images=()
imagepaths=()
for i in images
do 

done 
```



```
docker save ampregistry:5000/pangu-ms-person:pangu-1.0.6-rc03-patch04   | pv | pixz | pv  > pangu-ms-person_1.0.6_patch04.tar.xz

sudo docker save ampregistry:5000/middle-end-pass:pangu-1.0.6-rc03-patch04   | pv | pixz | pv   >middle-end-pass_1.0.6_patch04.tar.xz

sudo docker save ampregistry:5000/middle-end-device:pangu-1.0.6-rc03-patch04  | pv | pixz | pv  > middle-end-device_1.0.6_patch04.tar.xz
```



```
sudo ./sdc-upload-linux -k eyJpZCI6MTg1NH0.FK7aVA.rSC9NCRhSGVzVZZJeYWziIK260M -p EBG发布版本/盘古/test版本/主线版本/V1.0.6/V1.0.6.RC03/patch/middle-end-device/ middle-end-device_1.0.6_patch04.tar.xz &
sudo ./sdc-upload-linux -k eyJpZCI6MTg1NH0.FK7aVA.rSC9NCRhSGVzVZZJeYWziIK260M -p EBG发布版本/盘古/test版本/主线版本/V1.0.6/V1.0.6.RC03/patch/middle-end-pass/ middle-end-pass_1.0.6_patch04.tar.xz &
sudo ./sdc-upload-linux -k eyJpZCI6MTg1NH0.FK7aVA.rSC9NCRhSGVzVZZJeYWziIK260M -p EBG发布版本/盘古/test版本/主线版本/V1.0.6/V1.0.6.RC03/patch/pangu-ms-person/ pangu-ms-person_1.0.6_patch04.tar.xz &
```





git@git-pd.megvii-inc.com:bbu-pd/pangu-oncall.git





1. 代码合并
   - 权限下放

#### 提测

版本之间的变更记录，提测jira标明



产品联动细节：

1. Action

提测单
