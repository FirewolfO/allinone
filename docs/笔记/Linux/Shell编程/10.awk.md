[TOC]

# awk简介

awk是一种非常强大的数据处理工具，其本身可以称为一种程序设计语言，因而具有其他程序设计语言所共同拥有的一些特征，例如变量、函数，以及表达式等。通过awk，用户可以编写一些非常实用的文本处理工具。本节将介绍awk的基础知识。

### 基本语法：

```powershell
awk pattern { actions }
```

在上面的语法中，pattern表示匹配模式，actions表示要执行的操作。以上语法表示当某个文本行符合pattern指定的匹配规则时，执行actions所执行的操作。在上面的语法中， pattern和actions都是可选的，但是两者必须保证至少有一个。如果省略匹配模式pattern，则表示对所有的文本行执行actions所表示的操作；如果省略actions，则表示将匹配成功的行输出到屏幕。

注意：actions前面的左大括号需与pattern位于同一行中

### 工作流程

在awk处理数据时，它会反复执行以下4个步骤：

（1）自动从指定的数据文件中读取行文本。

（2）自动更新awk的内置系统变量的值，例如列数变量NF、行数变量NR、行变量$0，以及各个列变量$1、$2等。

（3）依次执行程序中所有的匹配模式及其操作。

（4）当执行完程序中所有的匹配模式及其操作之后，如果数据文件中仍然有末读取的数据行，则返回到第（1）步，重复执行（1）～（4）的操作

<img src="https://gitee.com/firewolf/allinone/raw/master/images/image-20200812225734036.png"  width="400"  height = "400" />



### 执行awk程序的方式

与sed工具相似，用户也可以通过3种方式来执行awk程序，分别是命令行、awk脚本，以及可执行文件。

score.txt：

```txt
zangsan 12
liuxing 34
wangwu 99
lisi 80
tianqi 3
```

1. 通过命令行执行awk程序

   ```powershell
   awk 'program-text' datafile
   ```

   如：

   ```powershell
    awk '{print}' score.txt
   ```

2. 执行awk脚本

   ```po
   awk -f program-file file ..
   ```

   如：

   aw2.sh：

   ```powershell
   {print}
   ```

   执行程序

   ```powershell
   awk -f awk2.sh score.txt 
   ```

3. 可执行脚本文件

   ```powershell
   awk-script file
   ```

   awk的脚本文件，需要执行命令解释器：

   ```
   #!/bin/awk -f
   ```

   不过，具体awk在哪里，建议通过whereis命令查找一下。

   如：

   awk.sh

   ```powershell
   #!/usr/bin/awk -f
   {print}
   ```

   执行awk程序

   ```powershell
    ./awk.sh score.txt 
   ```



# awk的匹配模式

在awk中，匹配模式处于非常重要的地位，它决定着匹配模式后面的操作会影响到哪些文本行。awk中的匹配模式主要包括关系表达式、正则表达式、混合模式，BEGIN模式，以及END模式等。

### 关系表达式

awk提供了许多关系运算符，例如大于＞、小于＜或者等于==等，关于关系运算符的详细使用方法。awk允许用户使用关系表达式作为匹配模式，当某个文本行满足关系表达式时，将会执行相应的操作。

如：找出第二列值大于20的数据

```powershell
 awk '$2 > 20 { print }' score.txt
```

### 正则表达式

awk支持以正则表达式作为匹配模式，与sed一样，用户需要将正则表达式放在两条斜线之间。

```powershell
/regular_expression/
```

如：

```powershell
awk '/liuxing/ {print}' score.txt 
```

### 混合模式

awk不仅支持单个的关系表达式或者正则表达式作为模式，还支持使用逻辑运算符&&、||或者!将多个表达式组合起来作为一个模式。其中，&&表示逻辑与，||表示逻辑或，!表示逻辑非。

如：

```powershell
awk '/liuxing/ && $2>20  {print}' score.txt 
```

### 区间模式

awk还支持一种区间模式，也就是说通过模式可以匹配一段连续的文本行

```powershell
pattern1, pattern2
```

如：

```powershell
awk  '/zangsan/,$2>20 {print}' score.txt 
```

### BEGIN模式

BEGIN模式是一种特殊的内置模式，其成立的时机为awk程序刚开始执行，但是又尚未读取任何数据之前。因此，该模式所对应的操作仅仅被执行一次，当awk读取数据之后， BEGIN模式便不再成立。所以，用户可以将与数据文件无关，而且在整个程序的生命周期中，只需执行一次的代码放在BEGIN模式对应的操作中。

如：

begin.sh

```powershell
BEGIN{
        print "Hello,World!"
}
```

执行：

```powershell
awk -f begin.sh
```

这个程序只是打印了"Hello,World!"

### END模式

END模式是awk的另外一种特殊模式，该模式成立的时机与BEGIN模式恰好相反，它是在awk命令处理完所有的数据，即将退出程序时成立，在此之前，END模式并不成立。无论数据文件中包含多少行数据，在整个程序的生命周期中，该模式所对应的操作只被执行一次。因此，一般情况下，用户可以将许多善后工作放在END模式对应的操作中。

end.sh

```powershell
BEGIN{
        print "start!"
}
{ print }
END{
        print "end"
}

```

执行：

```powershell
 awk -f end.sh score.txt 
```



# 变量

与其他程序设计语言一样，awk本身支持变量的相关操作，包括变量的定义和引用，以及参与相关的运算

### 系统内置变量

akw提供了许多非常实用的系统变量，例如字段变量、字段数变量，以及记录数变量等

| 变　量   | 说　明                                             |
| -------- | -------------------------------------------------- |
| $0       | 记录变量，表示当前正在处理的记录                   |
| $n       | 字段变量，其中n为整数，且n大于1。表示第n个字段的值 |
| NF       | 整数值，表示当前记录（变量$0所代表的记录）的字段数 |
| NR       | 整数值，表示awk已经读入的记录数                    |
| FILENAME | 表示正在处理的数据文件的名称                       |
| FS       | 字段分隔字符，默认值是空格或者制表符               |
| RS       | 记录分隔符，默认值是换行符                         |

awk会在读取数据行之前通过FS及RS确定记录和字段的分隔符，然后进行记录和字段的分隔。每读取一条记录之后，变量$0以及$1、$2等变量都会自动更新。

其中FS和RS，我们可以在BEGIN模式中进行更改。

下面演示部分变量的使用

首先，我把上面的score.txt中的空格全部替换成逗号，保存到score2.txt

```powershell
sed 's/ /,/g' score.txt  >score2.txt
```

然后，我打印这个文件里面的名字，最后打印出文件名

awk-vari.sh

```powershell
BEGIN{
        FS=","
}
{
        print $1 
}
END{
        print "filename is " FILENAME
}  
```

执行：

```po
awk -f awk-vari.sh score2.txt
```

效果如下：

```
zangsan
liuxing
wangwu
lisi
tianqi
filename is score2.txt
```



# 运算符

awk中也支持很多的运算符。

### 算术运算符

| 运　算　符 | 说　明   | 举　例                  |
| ---------- | -------- | ----------------------- |
| +          | 加法运算 | 1+2表示计算1和2的和     |
| -          | 减法运算 | 82-2表示计算82和2的差   |
| *          | 乘法运算 | 2*5表示计算2和5的积     |
| /          | 除法运算 | 6/3表示计算6和2的商     |
| %          | 求模运算 | 5/2表示计算5除以2的余数 |
| ^          | 指数运算 | 2^3表示计算2的3次方     |

### 赋值运算符

| 运　算　符 | 说　明                                                       | 举　例                                                       |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| =          | 赋值运算                                                     | x=5表示将数值5赋给变量x                                      |
| +=         | 复合赋值运算，表示将前后两个数值相加后的和赋给前面的变量     | x+=5表示先将x的值与5相加，然后将和赋给变量x，等价于表达式x=x+5 |
| -=         | 复合赋值运算，表示将前后两个数值相减后的查赋给前面的变量     | x-=5表示先将变量x的值减去5，然后将得到的差赋给变量x，等价于表达式x=x-5 |
| *=         | 复合赋值运算，表示前后两个数值的乘积赋给前面的变量           | x*=5表示先将变量x的值乘以5，然后将得到的乘积赋给变量x        |
| /=         | 复合赋值运算，表示将前后两个数值的商赋给前面的变量           | x/=5表示先将变量x除以5，然后将得到的商赋给变量x              |
| %=         | 复合赋值运算，表示将前面的数值除以后面的数值所得的余数赋给前面的变量 | x%=5表示将变量x与5相除后的余数赋给变量x                      |
| ^=         | 复合运算符，表示将前面的数值的后面数值次方赋给前面的变量     | x^=3表示将变量x的3次方赋给变量x                              |

### 条件运算符

```powershell
expression?value1:value2
```

### 逻辑运算符

| 运　算　符 | 说　明                                                       | 举　例              |
| ---------- | ------------------------------------------------------------ | ------------------- |
| &&         | 逻辑与，当前后两个表达式的值全部为真时，其运算结果才为真，反之则为假 | 1>2&&3>2的值为假    |
| \|\|       | 逻辑或，前后两个表达式只要有一个为真，则其运算结果为真。当两个表达式的值都为假时，其运算结果才为假 | •1>2\|\|3>2的值为真 |
| !          | 逻辑非，当表达式的值为真时，其运算结果为假；当表达式的值为假时，其运算结果为真 | !(1>2)的值为真      |

### 关系运算符

| 运算符 | 说　明       | 举　例                                      |
| ------ | ------------ | ------------------------------------------- |
| >      | 大于         | 5>2的值为真                                 |
| >=     | 大于或者等于 | 8>=8的值为真                                |
| <      | 小于         | 8<12的值为假                                |
| <=     | 小于或者等于 | 4<=7的值为真                                |
| ==     | 等于         | 8==8的值为真                                |
| !=     | 不等于       | 1!=3的值为真                                |
| ～     | 匹配运算符   | $1～/^T/表示匹配第1个字段以字符T开头的记录  |
| !～    | 不匹配运算符 | $1 !～/a/表示匹配第1个字段不含有字符a的记录 |

### 其他运算符

除了前面介绍的运算符之外，awk还支持其他的一些运算符，例如正号+、负号-、自增++，以及自减--等



