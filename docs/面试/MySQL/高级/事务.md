[toc]

# 基础知识

## 基本概念

**事务定义：**一组逻辑操作单元，使数据从一种状态变换到另一种状态。

**事务处理的原则：**保证所有事务都作为 一个工作单元 来执行，即使出现了故障，都不能改变这种执行方式。当在一个事务中执行多个操作时，要么所有的事务都被提交( commit )，那么这些修改就 永久 地保存下来；要么数据库管理系统将 放弃 所作的所有 修改 ，整个事务回滚( rollback )到最初状态。



## ACID特性

- 原子性（atomicity）：原子性是指事务是一个不可分割的工作单位，要么全部提交，要么全部失败回滚

- 一致性（consistency）：事务执行前后，数据从一个 合法性状态 变换到另外一个 合法性状态 。这种状态是语义上 的而不是语法上的，跟具体的业务有关。

- 隔离型（isolation）：指一个事务的执行 不能被其他事务干扰 ，即一个事务内部的操作及使用的数据对 并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。

- 持久性（durability）：持久性是指一个事务一旦被提交，它对数据库中数据的改变就是 永久性的 ，接下来的其他操作和数据库

  故障不应该对其有任何影响。

> 隔离性是有锁和MVCC机制来保证的
>
> 持久性是由Redo Log实现的
>
> 原子性、一致性是由Undo Log实现



## 事务的状态

 <img src="https://gitee.com/firewolf/allinone/raw/master/images/image-20220308171656028.png" alt="image-20220308171656028" style="zoom:50%;" />



## 事务分类

### 按照是否可见

- 显示事务：通过START TRANSACTION 或者 BEGIN 开启事务，通过ROLLBACK回滚事务或者通过COMMIT 提交事务

  - 常用方式如下：

    ```sql
    # 1. 开启事务
    START TRANSACTION 或者 BEGIN  
    # 2. 执行一系列操作
    ...
    # [设置保存点]
    [SAVEPOINT point_name]
    
    # 3. 提交或者回滚事务
    COMMIT 或者 ROLLBACK 或者 ROLLBACK TO [SAVEPOINT]
    ```

  - `START TRANSACTION` 和 `BEGIN`区别

    相较于`BEGIN`，`START TRANSACTION`后面可以跟随如下修饰：

    - `READ ONLY `：标识当前事务是一个 只读事务
    - `READ WRITE `：标识当前事务是一个 读写事务
    - `WITH CONSISTENT SNAPSHOT`：启动一致性读，会立即建立本事务的一致性读snapshot；否则，会在第一条select语句建立一致性读的snapshot；

- 隐式事务：默认情况下，Mysql会通过隐式的方式完成事务操作

  - 查看是否是自动提交：`show variables like 'autocommit'`
  - 关闭自动提交：`SET autocommit = OFF` 或者 `SET autocommit = 0` 
  - 隐式提交数据的情况
    - DDL语句
    - 锁定表等，如：`LOCK TABLES`、`UNLOCK TABLES`，会隐式提交前面的事务

### 按照业务场景

- 扁平事务（Flat Transactions）
- 带有保存点的扁平事务（Flat Transactions with Savepoints）
- 链事务（Chained Transactions）
- 嵌套事务（Nested Transactions）
- 分布式事务（Distributed Transactions）



## 并发问题

- 脏写（Dirty Write）：对于两个事务  A、 B，如果事务 A 修改了 另一个 未提交 事务 B 修改过 的数据，那就意味着发生了 脏写
- 脏读（Dirty Read）：对于两个事务  A、 B， A 读取 了已经被  B 更新 但还 没有被提交 的字段。之后若  B 回滚 ， A 读取 的内容就是 临时且无效 的。
- 不可重复读（Non-Reaptable Read）：对于两个事务 A、 B， A 读取 了一个字段，然后 B 更新 了该字段。 之后A 再次读取 同一个字段， 值就不同 了。那就意味着发生了不可重复读。
- 幻读（Phantom）：对于两个事务 A、 B,  A 从一个表中 读取 了一个字段, 然后 B 在该表中 插 入 了一些新的行。 之后, 如果  A 再次读取 同一个表, 就会多出几行。那就意味着发生了幻读，这些多出来的行，被称为“幻影记录”。



## 隔离级别

- `READ UNCOMMITTED `：读未提交，在该隔离级别，所有事务都可以看到其他未提交事务的执行结果。不能避免脏读、不可重复读、幻读。

- `READ COMMITTED` ：读已提交，它满足了隔离的简单定义：一个事务只能看见已经提交事务所做的改变。这是大多数数据库系统的默认隔离级别（但不是MySQL默认的）。可以避免脏读，但不可重复读、幻读问题仍然存在。

- `REPEATABLE READ` ：可重复读，事务A在读到一条数据之后，此时事务B对该数据进行了修改并提交，那么事务A再读该数据，读到的还是原来的内容。可以避免脏读、不可重复读，但幻读问题仍然存在。这是MySQL的默认隔离级别。
- `SERIALIZABLE` ：可串行化，确保事务可以从一个表中读取相同的行。在这个事务持续期间，禁止其他事务对该表执行插入、更新和删除操作。所有的并发问题都可以避免，但性能十分低下。能避免脏读、不可重复读和幻读。
- <font color=red>MySQL默认的隔离级别是`REPEATABLE READ `</font>

>设置隔离级别：
>
>SET [GLOBAL|SESSION] TRANSACTION_ISOLATION = '隔离级别'  
>
>或者
>
>SET [GLOBAL|SESSION] TRANSACTION ISOLATION LEVEL 隔离级别; 
>
>设置的时候，多个单词的隔离级别，使用中横线连接，即：`READ-UNCOMMITTED`、 `READ-COMMITTED`、`REPEATABLE READ`



# Redo Log

REDO LOG 称为 重做日志 ，提供再写入操作，恢复提交事务修改的页操作，用来保证事务的持久性



[checkpoint](https://www.cnblogs.com/chenpingzhao/p/5107480.html)





# Undo 日志

UNDO LOG 称为 回滚日志 ，回滚行记录到某个特定版本，用来保证事务的原子性、一致性



# 锁



# MVCC