# 分布式系统数据一致性解决方案

业界对于数据一致性问题提出了相应的解决方案，目前比较成熟的方案有ACID特性、CAP理论、Base理论、DTP模型、2PC（两阶段提交）模型、3PC（三阶段提交）模型、TCC模型、可靠消息最终一致性模型、最大努力通知模型等。



# CAP

CAP是一致性（Consistency）、可用性（Availability）和分区容忍性（Partition Tolerance）首字母的缩写。

- 一致性
  一致性是指用户对数据的更新操作（包括新增、修改和删除），要么在所有的数据副本都执行成功，要么在所有的数据副本都执行失败。也就是说，一致性要求对所有数据节点的数据副本的修改是原子操作。所有数据节点的数据副本的数据都是最新的，从任意数据节点读取的数据都是最新的状态。
- 可用性
  可用性指的是客户端访问数据的时候，能够快速得到响应。需要注意的是，系统处于可用性状态时，每个存储节点的数据可能会不一致，并不要求应用程序向数据库写入数据时能够立刻读取到最新的数据。也就是说，处于可用性状态的系统，任何事务的操作都可以得到响应的结果，不会存在超时或者响应错误的情况
- 分区容忍性
  如果只是将存储系统部署并运行在一个节点上，当系统出现故障时，整个系统将不可用。如果将存储系统部署并运行在多个不同的节点上，并且这些节点处于不同的网络中，这就形成了网络分区。此时，不可避免地会出现网络问题，导致节点之间的通信出现失败的情况，但是，此时的系统仍能对外提供服务，这就是分区容忍性

## CAP的组合

- AP：架构设计方案采用了最终一致性，允许多个节点的数据在一定的时间内存在差异，一段时间后达到数据一致的状态。
- CP：跨行转账业务需要每个银行系统都执行完转账操作的整个事务才算完成，这是典型的CP方式。
- CA：主数据库和从数据库不再进行数据同步，此时系统也不再是一个标准的分布式系统

# Base理论



# TCC

TCC操作服务模式主要包括3个阶段，分别为Try阶段（尝试业务执行）、Confirm阶段（确定业务执行）和Cancel阶段（取消业务执行）

## Try阶段

1. 完成所有业务的一致性检查。
2. 预留必要的业务资源，并需要与其他操作隔离。

## Confirm阶段

1. 此阶段会真正执行业务操作。
2. 因为在Try阶段完成了业务的一致性检查，所以此阶段不会做任何业务检查。
3. 只用Try阶段预留的业务资源进行操作。
4. 此阶段的操作需要满足幂等性。

## Cancel阶段

1. 释放Try阶段预留的业务资源。
2. 此阶段的操作需要满足幂等性。



# 可靠消息最终一致性模型

可靠消息最终一致性分布式事务解决方案指的是事务的发起方执行完本地事务之后，发出一条消息，事务的参与方，也就是消息的消费者一定能够接收到这条消息并处理成功。这个方案强调的是只要事务发起方将消息发送给事务参与方，事务参与方就一定能够执行成功，事务最终达到一致的状态。



# XA二阶段提交

一阶段：执行XA PREPARE语句。事务管理器通知各个资源管理器准备提交它们的事务分支。资源管理器收到通知后执行XA PREPARE语句。

二阶段：执行XA COMMIT/ROLLBACK语句。事务管理器根据各个资源管理器的XA PREPARE语句执行结果，决定是提交事务还是回滚事务。如果所有的资源管理器都预提交成功，那么事务管理器通知所有的资源管理器执行XA提交操作；如果有资源管理器的XA PREPARE语句执行失败，则由事务管理器通知所有资源管理器执行XA回滚操作。





